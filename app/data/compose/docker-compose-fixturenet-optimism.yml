version: '3.7'

services:
  fixturenet-optimism-contracts:
    hostname: fixturenet-optimism-contracts
    depends_on:
      fixturenet-eth-geth-1:
        condition: service_healthy
    image: cerc/fixturenet-optimism:local
    environment:
      CHAIN_ID: 1212
      L1_RPC: "http://fixturenet-eth-geth-1:8545"
    command: ["sh", "run.sh"]
    volumes:
      - ../config/fixturenet-optimism/optimism-contracts/rekey-json.ts:/app/packages/contracts-bedrock/tasks/rekey-json.ts
      - ../config/fixturenet-optimism/optimism-contracts/send-balance.ts:/app/packages/contracts-bedrock/tasks/send-balance.ts
      - ../config/fixturenet-optimism/optimism-contracts/update-config.js:/app/packages/contracts-bedrock/update-config.js
      - ../config/fixturenet-optimism/optimism-contracts/run.sh:/app/packages/contracts-bedrock/run.sh
      - fixturenet-geth-accounts:/geth-accounts
      - l2-accounts:/l2-accounts
    # TODO: Add healthcheck
    # healthcheck:

  op-node-l2-config-gen:
    environment:
      # TODO: Integrate
      L1_RPC: "http://fixturenet-eth-geth-1:8545"
    image: cerc/optimism-op-node:local
    volumes:
      - ../config/fixturenet-optimism/generate-l2-config.sh:/app/generate-l2-config.sh
      # TODO: Integrate
      - ../test/contracts-bedrock:/contracts-bedrock
      - op_node_data:/app
    command: ["sh", "/app/generate-l2-config.sh"]

  op-geth:
    image: cerc/optimism-l2geth:local
    depends_on:
      op-node-l2-config-gen:
        condition: service_started
    volumes:
      - ../config/fixturenet-optimism/run-op-geth.sh:/run-op-geth.sh
      - op_node_data:/op-node
      # TODO: Integrate
      - ../test/l2-accounts:/l2-accounts
    entrypoint: "sh"
    command: "/run-op-geth.sh"
    ports:
      - "8545"
    healthcheck:
      test: ["CMD", "nc", "-vz", "localhost:8545"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 10s

  op-node:
    environment:
      # TODO: Integrate
      L1_RPC: "http://fixturenet-eth-geth-1:8545"
    depends_on:
      op-geth:
        condition: service_healthy
    image: cerc/optimism-op-node:local
    volumes:
      - ../config/fixturenet-optimism/run-op-node.sh:/app/run-op-node.sh
      - op_node_data:/app
      # TODO: Integrate
      - ../test/l2-accounts:/l2-accounts
    command: ["sh", "/app/run-op-node.sh"]

volumes:
  op_node_data:
  l2-accounts:
  # TODO: Required?
  # fixturenet-geth-accounts:

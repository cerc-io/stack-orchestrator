version: '3.7'

services:
  nitro-reverse-payment-proxy:
    image: cerc/go-nitro:local
    hostname: nitro-reverse-payment-proxy
    restart: on-failure
    depends_on:
      # Wait for the go-nitro node to start
      go-nitro:
        condition: service_healthy
    environment:
      PROXY_ADDRESS: 0.0.0.0:${PROXY_PORT:-8081}
      PROXY_NITRO_ENDPOINT: ${PROXY_NITRO_ENDPOINT:-go-nitro:${NITRO_RPC_PORT:-4005}/api/v1}
      PROXY_DESTINATION_URL: ${PROXY_DESTINATION_URL:-http://ipld-eth-server:8081}
      PROXY_COST_PER_BYTE: ${PROXY_COST_PER_BYTE:-1}
    entrypoint: ["bash", "-c", "/app/run-reverse-payment-proxy.sh"]
    volumes:
      - ../config/go-nitro/run-reverse-payment-proxy.sh:/app/run-reverse-payment-proxy.sh
    healthcheck:
      test: ["CMD", "nc", "-vz", "localhost", "${PROXY_PORT:-8081}"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s
    ports:
      - "${PROXY_PORT:-8081}"
